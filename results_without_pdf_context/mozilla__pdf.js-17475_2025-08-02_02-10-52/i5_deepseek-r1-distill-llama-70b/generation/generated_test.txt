it("should include highlights in cropped PDFs when saving", async () => {
  const { PDFDocument, PDFPage } = await import("../../src/core/document.js");
  const { AnnotationFactory } = await import("../../src/core/annotation.js");
  const { PDFDocument as PDFJSDocument, PDFPageProxy } = await import("../../src/display/api.js");

  // Create a new PDF document with a cropped page
  const pdf = new PDFDocument();
  const page = pdf.addPage([0, 0, 100, 100]); // Cropped page

  // Create and add a highlight annotation
  const annotation = AnnotationFactory.createHighlight({
    page,
    quads: [[0, 0, 10, 0, 10, 10, 0, 10]],
    color: [1, 0, 0],
  });

  // Save the PDF with the annotation
  const pdfBytes = await pdf.save();
  const pdfJS = await PDFJSDocument.load(pdfBytes.buffer);

  // Verify the annotation is correctly rendered
  const pageProxy = pdfJS.getPage(0);
  const annotations = await pageProxy.getAnnotations();
  expect(annotations.length).toBe(1);
});