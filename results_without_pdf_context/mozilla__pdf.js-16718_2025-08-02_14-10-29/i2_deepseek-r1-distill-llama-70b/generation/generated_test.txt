it("should correctly save annotations when AcroForm needs appearances", async () => {
  const { PDFDocument } = await import("../../src/core/document.js");
  const { Annotation, AnnotationBorderStyle } = await import("../../src/core/annotation.js");
  const { writeDict } = await import("../../src/core/writer.js");

  // Create a simple PDF with one page
  const pdf = new PDFDocument();
  const page = pdf.addPage();

  // Create a test annotation
  const rect = [100, 100, 200, 200];
  const annotation = new Annotation({
    type: "Highlight",
    rect,
    page: 0,
    color: "#FF0000",
    border: new AnnotationBorderStyle({ width: 2 }),
  });

  // Save the document
  const saveResult = await pdf.save({
    annotations: [annotation],
    flags: 3, // Save with annotations
  });

  // Reload the saved document
  const loadedPdf = await PDFDocument.load(saveResult.bytes);

  // Check if the annotation was correctly saved
  const [firstPage] = await loadedPdf.getPages();
  const annotations = await firstPage.getAnnotations();

  expect(annotations.length).toBe(1);
});